<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ChatNoir Cached Webpage</title>

    {% load static %}
    {% include 'header.html' %}
</head>
<body class="cache-page">
    {% include 'maintenance.html' %}
    <div id="Main" class="container">
        <div id="CacheHeader">
            <div id="LogoWrapper">
                <a rel="home" href="{%  url 'search:index' %}" title="ChatNoir">
                    <img src="{% static 'img/chatnoir.svg' %}" id="Logo" alt="ChatNoir Logo">
                </a>
            </div>
            <div id="CacheMeta">
                <h1>Cache Result for document <em>{{ cache.uuid }}</em> ({{ cache.index }})</h1>
                <p>
                {% if cache.search_query %}
                    <a href="{%  url 'search:index' %}?q={{ cache.search_query | urlencode }}{% if cache.search_page %}&p={{ cache.search_page }}{% endif %}" class="back">Back to search</a> –
                {% endif %}
                    <a href="{{ cache.uri }}" class="weblink" target="_blank">View original web page</a> –
                    <a href="{%  url 'search:cache' %}?uuid={{ cache.uuid | urlencode }}&amp;index={{ cache.index | urlencode }}" class="html"{% if not cache.is_plaintext_mode %} style="display: none"{% endif %}>View original HTML</a>
                    <a href="{%  url 'search:cache' %}?uuid={{ cache.uuid | urlencode }}&amp;index={{ cache.index | urlencode }}&amp;plain" class="plaintext"{% if cache.is_plaintext_mode %} style="display: none"{% endif %}>View plain text</a>
                </p>
            </div>
        </div>
        <div id="CacheResult">
            <iframe src="{%  url 'search:cache' %}?uuid={{ cache.uuid | urlencode }}&amp;index={{ cache.index | urlencode }}&amp;raw{% if cache.is_plaintext_mode %}&amp;plain{% endif %}"></iframe>
        </div>
    </div>

    {% include 'footer.html' %}

    <script>
        let meta = $('#CacheMeta');
        let result = $('#CacheResult');
        let iframe = result.find('iframe');
        let plainTextLink = meta.find('a.plaintext');
        let htmlLink = meta.find('a.html');

        function toggleLinks() {
            let url = new URL(iframe.contents().get(0).location.href);
            let urlParams = new URLSearchParams(url.search);
            if (urlParams.has('plain')) {
                plainTextLink.hide();
                htmlLink.show();
            } else {
                plainTextLink.show();
                htmlLink.hide();
            }
        }

        plainTextLink.click((e) => {
            e.preventDefault();
            iframe.contents().get(0).location.href += "&plain"
            toggleLinks();
        });

        htmlLink.click((e) => {
            e.preventDefault();
            let url = new URL(iframe.contents().get(0).location.href);
            let urlParams = new URLSearchParams(url.search);
            urlParams.delete('plain');
            url.search = urlParams.toString();
            iframe.contents().get(0).location.href = url.toString();
            toggleLinks();
        });

        iframe.load(() => {
            toggleLinks();
        });
    </script>
</body>
</html>
